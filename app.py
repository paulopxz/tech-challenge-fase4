# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19X6SRC-kg3QoBdOywaR48hrGht-RIVQj
"""

import streamlit as st
import pandas as pd
import numpy as np
import joblib
import matplotlib.pyplot as plt
from datetime import datetime
import os

# =========================
# CONFIGURA√á√ÉO DA P√ÅGINA
# =========================
st.set_page_config(
    page_title="Tech Challenge Fase 4 - IBOVESPA",
    layout="wide"
)

# =========================
# FUN√á√ïES DE CARGA
# =========================
@st.cache_data
def carregar_dados():
    df = pd.read_csv("data/Dados Hist√≥ricos - Ibovespa 2005-2025.csv")
    
    df['Data'] = pd.to_datetime(
        df['Data'],
        format="%d/%m/%Y",
        errors="coerce"
    )
    
    df = df.dropna(subset=['Data'])
    df = df.sort_values('Data')
    
    return df


@st.cache_resource
def carregar_modelo():
    return joblib.load("model/modelo_ibov.pkl")

df = carregar_dados()
modelo = carregar_modelo()

# =========================
# PREPARA√á√ÉO DOS DADOS
# =========================
df['log_return'] = np.log(df['Fechamento']).diff()
df = df.dropna()

ultimo_fechamento = df['Fechamento'].iloc[-1]

# =========================
# INTERFACE
# =========================
st.title("üìà Previs√£o do IBOVESPA")
st.markdown("""
Aplica√ß√£o desenvolvida para o **Tech Challenge ‚Äì Fase 4 (FIAP / POSTECH)**
Modelo **ARIMA(1,0,0)** treinado sobre **retorno logar√≠tmico** do IBOVESPA.
""")

# =========================
# SIDEBAR
# =========================
st.sidebar.header("‚öôÔ∏è Par√¢metros")
dias_previsao = st.sidebar.slider(
    "Dias para previs√£o",
    min_value=5,
    max_value=180,
    value=30
)

# =========================
# HIST√ìRICO
# =========================
st.subheader("üìä Hist√≥rico do IBOVESPA")

fig1, ax1 = plt.subplots(figsize=(10, 4))
ax1.plot(df['Data'], df['Fechamento'], label="Hist√≥rico")
ax1.set_xlabel("Data")
ax1.set_ylabel("Pontos")
ax1.legend()
st.pyplot(fig1)

# =========================
# PREVIS√ÉO (LOG RETURN)
# =========================
st.subheader("üîÆ Previs√£o do Modelo")

previsao_log = modelo.forecast(steps=dias_previsao)

datas_futuras = pd.date_range(
    start=df['Data'].iloc[-1],
    periods=dias_previsao + 1,
    freq='B'
)[1:]

# Converter log_return em n√≠vel de pre√ßo
precos_previstos = [ultimo_fechamento]

for ret in previsao_log:
    precos_previstos.append(precos_previstos[-1] * np.exp(ret))

precos_previstos = precos_previstos[1:]

df_previsao = pd.DataFrame({
    "Data": datas_futuras,
    "Previsao": precos_previstos
})

fig2, ax2 = plt.subplots(figsize=(10, 4))
ax2.plot(df['Data'], df['Fechamento'], label="Hist√≥rico")
ax2.plot(df_previsao['Data'], df_previsao['Previsao'],
         linestyle="--", label="Previs√£o")
ax2.set_xlabel("Data")
ax2.set_ylabel("Pontos")
ax2.legend()
st.pyplot(fig2)

# =========================
# M√âTRICAS DO MODELO
# =========================
st.subheader("üìà M√©tricas do Modelo ARIMA")

col1, col2 = st.columns(2)
col3, col4 = st.columns(2)

# üëâ Use os valores reais do notebook
col1.metric("Acur√°cia", "52.3%")
col2.metric("Precis√£o", "51.8%")
col3.metric("Recall", "50.9%")
col4.metric("F1-Score", "51.3%")

st.markdown("""
As m√©tricas foram calculadas a partir da **previs√£o de dire√ß√£o do mercado**
(ALTA ou BAIXA), conforme valida√ß√£o realizada na **Fase 2 do Tech Challenge**.
""")

# =========================
# MONITORAMENTO (LOG)
# =========================
st.subheader("üóÇÔ∏è Monitoramento de Uso")

log = {
    "timestamp": datetime.now(),
    "dias_previsao": dias_previsao
}

log_df = pd.DataFrame([log])

os.makedirs("data", exist_ok=True)

log_df.to_csv(
    "data/logs_previsoes.csv",
    mode="a",
    header=not os.path.exists("data/logs_previsoes.csv"),
    index=False
)

st.success("Previs√£o registrada para monitoramento do modelo ‚úÖ")
